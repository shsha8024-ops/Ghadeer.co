<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ghadeer Accounts</title>
  <style>
    :root{
      --bg:#0b1224;
      --card:#11182f;
      --card2:#0f1630;
      --txt:#e9ecff;
      --muted:#aab3d6;
      --line:#22305a;
      --btn:#2b5cff;
      --danger:#ff6b6b;
      --ok:#32d296;
      --radius:14px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
    body{margin:0;background:linear-gradient(180deg,#08102a,#050816);color:var(--txt)}
    .hidden{display:none!important}

    /* LOGIN */
    .login-gate{
      position:fixed; inset:0; background:rgba(5,8,22,.92);
      display:flex; align-items:center; justify-content:center; z-index:9999;
      padding:16px;
    }
    .login-card{
      background:linear-gradient(180deg,var(--card),#0b1330);
      padding:22px; border-radius:var(--radius);
      width:min(360px,100%); color:var(--txt);
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .login-card h3{margin:0 0 14px 0; font-size:18px}
    .login-card input{
      width:100%; margin-bottom:10px; padding:10px 12px;
      border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background:#0a1230; color:var(--txt);
      outline:none;
    }
    .login-card button{
      width:100%; padding:10px 12px;border-radius:12px;border:0;
      background:var(--btn); color:#fff; cursor:pointer; font-weight:700;
    }
    .error{color:var(--danger); font-size:13px; margin-top:10px}
    .hint{color:var(--muted); font-size:12px; margin-top:10px; line-height:1.5}

    /* APP */
    header.app-header{
      position:sticky; top:0; z-index:10;
      background:rgba(10,16,42,.75);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .bar{
      max-width:1100px; margin:0 auto; padding:12px 14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .brand .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg,#2b5cff,#7c3aed);
      display:grid;place-items:center;font-weight:900;
    }
    .brand .title{display:flex;flex-direction:column}
    .brand .title b{font-size:14px}
    .brand .title span{font-size:12px;color:var(--muted)}

    #tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:9px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background:#0a1230; color:var(--txt); cursor:pointer;
      font-weight:700; font-size:13px;
    }
    .tab.active{background:rgba(43,92,255,.18); border-color:rgba(43,92,255,.45)}
    .logout{
      padding:9px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background:#0a1230; color:var(--txt); cursor:pointer; font-weight:800;
    }
    .logout:hover{border-color:rgba(255,107,107,.55); color:#ffd6d6}

    main{
      max-width:1100px; margin:0 auto; padding:16px 14px 40px;
    }
    .grid{
      display:grid; grid-template-columns:1fr; gap:12px;
    }
    @media(min-width:900px){
      .grid.cols2{grid-template-columns:1.1fr .9fr}
      .grid.cols3{grid-template-columns:1fr 1fr 1fr}
    }
    .card{
      background:linear-gradient(180deg,var(--card),#0b1330);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
    }
    .card h4{margin:0 0 10px 0; font-size:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1 1 160px}
    input, select{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:#0a1230; color:var(--txt); outline:none;
    }
    .btn{
      padding:10px 12px;border-radius:12px;border:0;
      background:var(--btn); color:#fff; cursor:pointer; font-weight:800;
      width:100%;
    }
    .btn.secondary{background:#14204a;border:1px solid rgba(255,255,255,.10)}
    .btn.danger{background:rgba(255,107,107,.16); border:1px solid rgba(255,107,107,.35)}
    .btn.small{width:auto; padding:8px 10px; font-size:12px}
    .muted{color:var(--muted); font-size:12px}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.07); font-size:13px}
    th{color:var(--muted); text-align:right; font-weight:800}
    tr:hover td{background:rgba(255,255,255,.03)}
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04);
      color:var(--muted); font-size:12px;
    }
    .kpi{display:flex; flex-direction:column; gap:6px}
    .kpi b{font-size:22px}
    .pos{color:var(--ok)}
    .neg{color:var(--danger)}
    .footnote{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.6}
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="loginGate" class="login-gate">
  <div class="login-card">
    <h3>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input id="lg_user" placeholder="admin" autocomplete="username" />
    <input id="lg_pass" type="password" placeholder="password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>
    <div id="lg_error" class="error hidden">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <div class="hint">
      Ù‡Ø°Ø§ Ù‚ÙÙ„ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø· (Ù„ÙŠØ³ Ø£Ù…Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ). Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ.<br>
      Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: <span class="pill">admin / admin</span>
    </div>
  </div>
</div>

<header class="app-header hidden" id="appHeader">
  <div class="bar">
    <div class="brand">
      <div class="logo">G</div>
      <div class="title">
        <b>Ghadeer Accounts</b>
        <span class="muted">Clients â€¢ Transactions â€¢ Expenses â€¢ Summary</span>
      </div>
    </div>

    <nav id="tabs">
      <button class="tab active" data-tab="clients">Clients</button>
      <button class="tab" data-tab="transactions">Transactions</button>
      <button class="tab" data-tab="expenses">Expenses</button>
      <button class="tab" data-tab="summary">Summary</button>
    </nav>

    <button id="logoutBtn" class="logout">Logout</button>
  </div>
</header>

<main id="app" class="hidden">

  <!-- CLIENTS -->
  <section id="clients" class="tab-pane">
    <div class="grid cols2">
      <div class="card">
        <h4>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</h4>
        <div class="row">
          <input id="c_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          <input id="c_phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" />
          <input id="c_city" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" />
        </div>
        <div class="row" style="margin-top:10px">
          <button id="addClientBtn" class="btn">Add Client</button>
          <button id="clearAllBtn" class="btn danger">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø®Ø·ÙŠØ±)</button>
        </div>
        <div class="footnote">
          Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² (localStorage). Ø¥Ø°Ø§ Ù…Ø³Ø­Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØµÙØ­â€¦ Ø±Ø§Ø­Øª.
        </div>
      </div>

      <div class="card">
        <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4>
        <div class="muted" style="margin-bottom:8px">Ø§Ø¶ØºØ· Ø­Ø°Ù Ù„Ø¥Ø²Ø§Ù„Ø© Ø¹Ù…ÙŠÙ„ (ÙˆÙ…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡).</div>
        <div style="overflow:auto; border-radius:12px; border:1px solid rgba(255,255,255,.07)">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody id="clientRows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- TRANSACTIONS -->
  <section id="transactions" class="tab-pane hidden">
    <div class="grid cols2">
      <div class="card">
        <h4>Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©</h4>
        <div class="row">
          <select id="t_client"></select>
          <input id="t_desc" placeholder="Ø§Ù„ÙˆØµÙ" />
          <input id="t_amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" />
          <input id="t_date" type="date" />
        </div>
        <div class="row" style="margin-top:10px">
          <button id="addInvoiceBtn" class="btn">Add Invoice</button>
          <button id="seedTodayBtn" class="btn secondary">ØªØ¹Ø¨Ø¦Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
        <div class="footnote">Ø§Ù„ÙÙˆØ§ØªÙŠØ± = Ø¯Ø®Ù„. Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨.</div>
      </div>

      <div class="card">
        <h4>ÙÙˆØ§ØªÙŠØ±</h4>
        <div style="overflow:auto; border-radius:12px; border:1px solid rgba(255,255,255,.07)">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody id="invoiceRows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- EXPENSES -->
  <section id="expenses" class="tab-pane hidden">
    <div class="grid cols2">
      <div class="card">
        <h4>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h4>
        <div class="row">
          <input id="e_desc" placeholder="Ø§Ù„Ù…ØµØ±ÙˆÙ" />
          <input id="e_amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" />
          <input id="e_date" type="date" />
        </div>
        <div class="row" style="margin-top:10px">
          <button id="addExpenseBtn" class="btn">Add Expense</button>
          <button id="seedTodayBtn2" class="btn secondary">ØªØ¹Ø¨Ø¦Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
        <div class="footnote">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ = Ø®Ø±ÙˆØ¬ Ù†Ù‚Ø¯. Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨.</div>
      </div>

      <div class="card">
        <h4>Ù…ØµØ§Ø±ÙŠÙ</h4>
        <div style="overflow:auto; border-radius:12px; border:1px solid rgba(255,255,255,.07)">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody id="expenseRows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- SUMMARY -->
  <section id="summary" class="tab-pane hidden">
    <div class="grid cols3">
      <div class="card kpi">
        <div class="muted">Total Invoices</div>
        <b id="s_totalInvoices">0</b>
        <div class="muted">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø®Ù„</div>
      </div>
      <div class="card kpi">
        <div class="muted">Total Expenses</div>
        <b id="s_totalExpenses">0</b>
        <div class="muted">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      </div>
      <div class="card kpi">
        <div class="muted">Net Profit</div>
        <b id="s_netProfit">0</b>
        <div class="muted">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h4>
      <div class="muted">
        Ø§Ù„ØµØ§ÙÙŠ = Ø§Ù„Ø¯Ø®Ù„ - Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ. Ø¥Ø°Ø§ Ø·Ù„Ø¹ Ø³Ø§Ù„Ø¨â€¦ Ù‡Ø°Ø§ Ù…Ùˆ â€œØ³Ø­Ø± Ù…Ø­Ø§Ø³Ø¨ÙŠâ€ØŒ Ù‡Ø°Ø§ Ø®Ø³Ø§Ø±Ø© ğŸ˜„
      </div>
    </div>
  </section>

</main>

<script>
/* =========================
   Small MD5 (for "admin")
   =========================
   Ù‡Ø°Ø§ Ø¨Ø³ Ø­ØªÙ‰ Ù…Ø§ Ù†Ø®Ø²Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù†Øµ ÙˆØ§Ø¶Ø­. Ù…Ùˆ Ø£Ù…Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ.
*/
function md5(str){
  // Minimal MD5 implementation (public domain style)
  function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32((a<<s)|(a>>> (32-s)),b)}
  function ff(a,b,c,d,x,s,t){return cmn((b&c)|((~b)&d),a,b,x,s,t)}
  function gg(a,b,c,d,x,s,t){return cmn((b&d)|(c&(~d)),a,b,x,s,t)}
  function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}
  function ii(a,b,c,d,x,s,t){return cmn(c^(b|(~d)),a,b,x,s,t)}
  function md51(s){
    let n=s.length, state=[1732584193,-271733879,-1732584194,271733878], i;
    for(i=64;i<=n;i+=64) md5cycle(state, md5blk(s.substring(i-64,i)));
    s=s.substring(i-64);
    let tail=Array(16).fill(0);
    for(i=0;i<s.length;i++) tail[i>>2] |= s.charCodeAt(i) << ((i%4)<<3);
    tail[i>>2] |= 0x80 << ((i%4)<<3);
    if(i>55){ md5cycle(state, tail); tail=Array(16).fill(0); }
    tail[14]=n*8;
    md5cycle(state, tail);
    return state;
  }
  function md5cycle(x,k){
    let a=x[0], b=x[1], c=x[2], d=x[3];
    a=ff(a,b,c,d,k[0],7,-680876936); d=ff(d,a,b,c,k[1],12,-389564586);
    c=ff(c,d,a,b,k[2],17,606105819); b=ff(b,c,d,a,k[3],22,-1044525330);
    a=ff(a,b,c,d,k[4],7,-176418897); d=ff(d,a,b,c,k[5],12,1200080426);
    c=ff(c,d,a,b,k[6],17,-1473231341); b=ff(b,c,d,a,k[7],22,-45705983);
    a=ff(a,b,c,d,k[8],7,1770035416); d=ff(d,a,b,c,k[9],12,-1958414417);
    c=ff(c,d,a,b,k[10],17,-42063); b=ff(b,c,d,a,k[11],22,-1990404162);
    a=ff(a,b,c,d,k[12],7,1804603682); d=ff(d,a,b,c,k[13],12,-40341101);
    c=ff(c,d,a,b,k[14],17,-1502002290); b=ff(b,c,d,a,k[15],22,1236535329);

    a=gg(a,b,c,d,k[1],5,-165796510); d=gg(d,a,b,c,k[6],9,-1069501632);
    c=gg(c,d,a,b,k[11],14,643717713); b=gg(b,c,d,a,k[0],20,-373897302);
    a=gg(a,b,c,d,k[5],5,-701558691); d=gg(d,a,b,c,k[10],9,38016083);
    c=gg(c,d,a,b,k[15],14,-660478335); b=gg(b,c,d,a,k[4],20,-405537848);
    a=gg(a,b,c,d,k[9],5,568446438); d=gg(d,a,b,c,k[14],9,-1019803690);
    c=gg(c,d,a,b,k[3],14,-187363961); b=gg(b,c,d,a,k[8],20,1163531501);
    a=gg(a,b,c,d,k[13],5,-1444681467); d=gg(d,a,b,c,k[2],9,-51403784);
    c=gg(c,d,a,b,k[7],14,1735328473); b=gg(b,c,d,a,k[12],20,-1926607734);

    a=hh(a,b,c,d,k[5],4,-378558); d=hh(d,a,b,c,k[8],11,-2022574463);
    c=hh(c,d,a,b,k[11],16,1839030562); b=hh(b,c,d,a,k[14],23,-35309556);
    a=hh(a,b,c,d,k[1],4,-1530992060); d=hh(d,a,b,c,k[4],11,1272893353);
    c=hh(c,d,a,b,k[7],16,-155497632); b=hh(b,c,d,a,k[10],23,-1094730640);
    a=hh(a,b,c,d,k[13],4,681279174); d=hh(d,a,b,c,k[0],11,-358537222);
    c=hh(c,d,a,b,k[3],16,-722521979); b=hh(b,c,d,a,k[6],23,76029189);
    a=hh(a,b,c,d,k[9],4,-640364487); d=hh(d,a,b,c,k[12],11,-421815835);
    c=hh(c,d,a,b,k[15],16,530742520); b=hh(b,c,d,a,k[2],23,-995338651);

    a=ii(a,b,c,d,k[0],6,-198630844); d=ii(d,a,b,c,k[7],10,1126891415);
    c=ii(c,d,a,b,k[14],15,-1416354905); b=ii(b,c,d,a,k[5],21,-57434055);
    a=ii(a,b,c,d,k[12],6,1700485571); d=ii(d,a,b,c,k[3],10,-1894986606);
    c=ii(c,d,a,b,k[10],15,-1051523); b=ii(b,c,d,a,k[1],21,-2054922799);
    a=ii(a,b,c,d,k[8],6,1873313359); d=ii(d,a,b,c,k[15],10,-30611744);
    c=ii(c,d,a,b,k[6],15,-1560198380); b=ii(b,c,d,a,k[13],21,1309151649);
    a=ii(a,b,c,d,k[4],6,-145523070); d=ii(d,a,b,c,k[11],10,-1120210379);
    c=ii(c,d,a,b,k[2],15,718787259); b=ii(b,c,d,a,k[9],21,-343485551);

    x[0]=add32(a,x[0]); x[1]=add32(b,x[1]); x[2]=add32(c,x[2]); x[3]=add32(d,x[3]);
  }
  function md5blk(s){
    let md5blks=[], i;
    for(i=0;i<64;i+=4){
      md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);
    }
    return md5blks;
  }
  function rhex(n){
    let s="", j;
    for(j=0;j<4;j++) s += ("0"+((n>>(j*8+4))&0x0F).toString(16)).slice(-1) + ("0"+((n>>(j*8))&0x0F).toString(16)).slice(-1);
    return s;
  }
  function hex(x){ for(let i=0;i<x.length;i++) x[i]=rhex(x[i]); return x.join(""); }
  function add32(a,b){ return (a+b) & 0xFFFFFFFF; }
  return hex(md51(str));
}

/* =========================
   App Logic
   ========================= */
document.addEventListener("DOMContentLoaded", () => {
  // Login config
  const USER = "admin";
  const PASS_HASH = "21232f297a57a5a743894a0e4a801fc3"; // md5("admin")
  const LS_LOGIN = "ga_loggedIn";
  const LS_DATA  = "ga_data_v1";

  // DOM
  const gate   = document.getElementById("loginGate");
  const app    = document.getElementById("app");
  const header = document.getElementById("appHeader");
  const error  = document.getElementById("lg_error");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  // Tabs
  const tabs = [...document.querySelectorAll(".tab")];
  const panes = [...document.querySelectorAll(".tab-pane")];

  // Data inputs
  const c_name = document.getElementById("c_name");
  const c_phone= document.getElementById("c_phone");
  const c_city = document.getElementById("c_city");
  const addClientBtn = document.getElementById("addClientBtn");
  const clearAllBtn  = document.getElementById("clearAllBtn");
  const clientRows   = document.getElementById("clientRows");

  const t_client = document.getElementById("t_client");
  const t_desc   = document.getElementById("t_desc");
  const t_amount = document.getElementById("t_amount");
  const t_date   = document.getElementById("t_date");
  const addInvoiceBtn = document.getElementById("addInvoiceBtn");
  const invoiceRows   = document.getElementById("invoiceRows");
  const seedTodayBtn  = document.getElementById("seedTodayBtn");

  const e_desc   = document.getElementById("e_desc");
  const e_amount = document.getElementById("e_amount");
  const e_date   = document.getElementById("e_date");
  const addExpenseBtn = document.getElementById("addExpenseBtn");
  const expenseRows   = document.getElementById("expenseRows");
  const seedTodayBtn2 = document.getElementById("seedTodayBtn2");

  const s_totalInvoices = document.getElementById("s_totalInvoices");
  const s_totalExpenses = document.getElementById("s_totalExpenses");
  const s_netProfit     = document.getElementById("s_netProfit");

  // Load or init data
  let data = loadData();

  // Auto login
  if (localStorage.getItem(LS_LOGIN) === "true") unlock();

  loginBtn.onclick = () => {
    const u = document.getElementById("lg_user").value.trim();
    const p = document.getElementById("lg_pass").value;
    if (u === USER && md5(p) === PASS_HASH) {
      localStorage.setItem(LS_LOGIN, "true");
      unlock();
    } else {
      error.classList.remove("hidden");
    }
  };

  logoutBtn.onclick = () => {
    localStorage.removeItem(LS_LOGIN);
    location.reload();
  };

  function unlock(){
    gate.classList.add("hidden");
    app.classList.remove("hidden");
    header.classList.remove("hidden");
    error.classList.add("hidden");
    renderAll();
  }

  // Tabs switching
  tabs.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      tabs.forEach(t=>t.classList.remove("active"));
      btn.classList.add("active");
      const id = btn.dataset.tab;
      panes.forEach(p=>p.classList.toggle("hidden", p.id !== id));
      if (id === "summary") renderSummary();
    });
  });

  // Helpers
  function nowISODate(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  seedTodayBtn.onclick = ()=> t_date.value = nowISODate();
  seedTodayBtn2.onclick= ()=> e_date.value = nowISODate();

  function saveData(){
    localStorage.setItem(LS_DATA, JSON.stringify(data));
  }
  function loadData(){
    const raw = localStorage.getItem(LS_DATA);
    if (!raw) return { clients:[], invoices:[], expenses:[] };
    try { return JSON.parse(raw); } catch { return { clients:[], invoices:[], expenses:[] }; }
  }
  function money(n){
    const x = Number(n)||0;
    return x.toLocaleString("ar-IQ", { maximumFractionDigits: 2 });
  }
  function uid(){
    return Math.random().toString(16).slice(2)+Date.now().toString(16);
  }

  // Clients
  addClientBtn.onclick = () => {
    const name = c_name.value.trim();
    if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„.");
    const client = {
      id: uid(),
      name,
      phone: c_phone.value.trim(),
      city: c_city.value.trim()
    };
    data.clients.push(client);
    saveData();
    c_name.value = c_phone.value = c_city.value = "";
    renderAll();
  };

  clearAllBtn.onclick = () => {
    const ok = confirm("Ø£ÙƒÙŠØ¯ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‡Ø°Ø§ Ù…Ø§ ÙŠØ±Ø¬Ø¹.");
    if (!ok) return;
    data = { clients:[], invoices:[], expenses:[] };
    saveData();
    renderAll();
  };

  function deleteClient(clientId){
    const client = data.clients.find(c=>c.id===clientId);
    const msg = client ? `Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${client.name}" ÙˆÙ…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡ØŸ` : "Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ";
    if (!confirm(msg)) return;
    data.clients = data.clients.filter(c=>c.id!==clientId);
    data.invoices = data.invoices.filter(i=>i.clientId!==clientId);
    saveData();
    renderAll();
  }

  // Invoices
  addInvoiceBtn.onclick = () => {
    if (data.clients.length === 0) return alert("Ø£Ø¶Ù Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
    const clientId = t_client.value;
    const desc = t_desc.value.trim();
    const amount = Number(t_amount.value);
    const date = t_date.value || nowISODate();

    if (!clientId) return alert("Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„.");
    if (!desc) return alert("Ø§ÙƒØªØ¨ ÙˆØµÙ.");
    if (!Number.isFinite(amount) || amount <= 0) return alert("Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨.");

    data.invoices.push({ id: uid(), clientId, desc, amount, date });
    saveData();
    t_desc.value = "";
    t_amount.value = "";
    t_date.value = "";
    renderAll();
  };

  function deleteInvoice(id){
    if (!confirm("Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ")) return;
    data.invoices = data.invoices.filter(x=>x.id!==id);
    saveData();
    renderAll();
  }

  // Expenses
  addExpenseBtn.onclick = () => {
    const desc = e_desc.value.trim();
    const amount = Number(e_amount.value);
    const date = e_date.value || nowISODate();

    if (!desc) return alert("Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ.");
    if (!Number.isFinite(amount) || amount <= 0) return alert("Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨.");

    data.expenses.push({ id: uid(), desc, amount, date });
    saveData();
    e_desc.value = "";
    e_amount.value = "";
    e_date.value = "";
    renderAll();
  };

  function deleteExpense(id){
    if (!confirm("Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")) return;
    data.expenses = data.expenses.filter(x=>x.id!==id);
    saveData();
    renderAll();
  }

  // Render
  function renderAll(){
    renderClients();
    renderClientSelect();
    renderInvoices();
    renderExpenses();
    renderSummary();
  }

  function renderClients(){
    clientRows.innerHTML = "";
    if (data.clients.length === 0){
      clientRows.innerHTML = `<tr><td colspan="4" class="muted">Ù…Ø§ÙƒÙˆ Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯.</td></tr>`;
      return;
    }
    data.clients.forEach(c=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(c.name)}</td>
        <td>${escapeHtml(c.phone||"â€”")}</td>
        <td>${escapeHtml(c.city||"â€”")}</td>
        <td><button class="btn small danger" data-del="${c.id}">Ø­Ø°Ù</button></td>
      `;
      clientRows.appendChild(tr);
    });
    clientRows.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick = ()=> deleteClient(b.dataset.del);
    });
  }

  function renderClientSelect(){
    t_client.innerHTML = "";
    if (data.clients.length === 0){
      const opt = document.createElement("option");
      opt.value = ""; opt.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡";
      t_client.appendChild(opt);
      return;
    }
    const opt0 = document.createElement("option");
    opt0.value=""; opt0.textContent="Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„...";
    t_client.appendChild(opt0);

    data.clients.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      t_client.appendChild(opt);
    });
  }

  function renderInvoices(){
    invoiceRows.innerHTML = "";
    if (data.invoices.length === 0){
      invoiceRows.innerHTML = `<tr><td colspan="5" class="muted">Ù…Ø§ÙƒÙˆ ÙÙˆØ§ØªÙŠØ± Ø¨Ø¹Ø¯.</td></tr>`;
      return;
    }
    const clientMap = new Map(data.clients.map(c=>[c.id,c.name]));
    const sorted = [...data.invoices].sort((a,b)=> (b.date||"").localeCompare(a.date||""));
    sorted.forEach(i=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(clientMap.get(i.clientId) || "â€”")}</td>
        <td>${escapeHtml(i.desc)}</td>
        <td>${money(i.amount)}</td>
        <td>${escapeHtml(i.date||"")}</td>
        <td><button class="btn small danger" data-del-inv="${i.id}">Ø­Ø°Ù</button></td>
      `;
      invoiceRows.appendChild(tr);
    });
    invoiceRows.querySelectorAll("[data-del-inv]").forEach(b=>{
      b.onclick = ()=> deleteInvoice(b.dataset.del-inv);
    });
  }

  function renderExpenses(){
    expenseRows.innerHTML = "";
    if (data.expenses.length === 0){
      expenseRows.innerHTML = `<tr><td colspan="4" class="muted">Ù…Ø§ÙƒÙˆ Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø¹Ø¯.</td></tr>`;
      return;
    }
    const sorted = [...data.expenses].sort((a,b)=> (b.date||"").localeCompare(a.date||""));
    sorted.forEach(e=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(e.desc)}</td>
        <td>${money(e.amount)}</td>
        <td>${escapeHtml(e.date||"")}</td>
        <td><button class="btn small danger" data-del-exp="${e.id}">Ø­Ø°Ù</button></td>
      `;
      expenseRows.appendChild(tr);
    });
    expenseRows.querySelectorAll("[data-del-exp]").forEach(b=>{
      b.onclick = ()=> deleteExpense(b.dataset.del-exp);
    });
  }

  function renderSummary(){
    const totalInvoices = data.invoices.reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const totalExpenses = data.expenses.reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const net = totalInvoices - totalExpenses;

    s_totalInvoices.textContent = money(totalInvoices);
    s_totalExpenses.textContent = money(totalExpenses);
    s_netProfit.textContent = money(net);

    s_netProfit.classList.remove("pos","neg");
    s_netProfit.classList.add(net >= 0 ? "pos" : "neg");
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
});
</script>

</body>
</html>
  <div>Total Invoices: <span id="s_totalInvoices"></span></div>
  <div>Total Expenses: <span id="s_totalExpenses"></span></div>
  <div>Net Profit: <span id="s_netProfit"></span></div>
</section>

</main>
</body>
</html>
